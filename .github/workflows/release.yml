name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: darwin-arm64
          - os: macos-latest
            target: darwin-x64
          - os: ubuntu-latest
            target: linux-x64
          - os: ubuntu-24.04-arm
            target: linux-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build binary
        run: bun build ./bin/orb.ts --compile --outfile orb

      - name: Create tarball
        run: tar -czvf orb-${{ matrix.target }}.tar.gz orb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: orb-${{ matrix.target }}
          path: orb-${{ matrix.target }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.tar.gz
          generate_release_notes: true

  update-tap:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Calculate SHA256 checksums
        id: sha
        run: |
          echo "darwin_arm64=$(sha256sum artifacts/orb-darwin-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "darwin_x64=$(sha256sum artifacts/orb-darwin-x64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum artifacts/orb-linux-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_x64=$(sha256sum artifacts/orb-linux-x64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update Homebrew tap
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.TAP_TOKEN }}
          script: |
            const version = context.ref.replace('refs/tags/v', '');

            const formula = `class Orb < Formula
              desc "A CLI for managing project templates and syncing common files across multiple projects."
              homepage "https://github.com/waynehaffenden/orb"
              version "${version}"
              license "MIT"

              on_macos do
                on_arm do
                  url "https://github.com/waynehaffenden/orb/releases/download/v${version}/orb-darwin-arm64.tar.gz"
                  sha256 "${{ steps.sha.outputs.darwin_arm64 }}"
                end

                on_intel do
                  url "https://github.com/waynehaffenden/orb/releases/download/v${version}/orb-darwin-x64.tar.gz"
                  sha256 "${{ steps.sha.outputs.darwin_x64 }}"
                end
              end

              on_linux do
                on_arm do
                  url "https://github.com/waynehaffenden/orb/releases/download/v${version}/orb-linux-arm64.tar.gz"
                  sha256 "${{ steps.sha.outputs.linux_arm64 }}"
                end

                on_intel do
                  url "https://github.com/waynehaffenden/orb/releases/download/v${version}/orb-linux-x64.tar.gz"
                  sha256 "${{ steps.sha.outputs.linux_x64 }}"
                end
              end

              def install
                bin.install "orb"
              end

              test do
                system "#{bin}/orb", "--version"
              end
            end
            `;

            let sha;
            try {
              const { data: file } = await github.rest.repos.getContent({
                owner: 'waynehaffenden',
                repo: 'homebrew-tap',
                path: 'Formula/orb.rb',
              });
              sha = file.sha;
            } catch (e) {
              // File doesn't exist yet, will create new
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner: 'waynehaffenden',
              repo: 'homebrew-tap',
              path: 'Formula/orb.rb',
              message: `chore: update to v${version}`,
              content: Buffer.from(formula).toString('base64'),
              ...(sha && { sha }),
            });
